I""<h1 id="oneapi">oneAPI</h1>

<p>å› ä¸ºé¡¹ç›®ä¸­æœ‰çŸ©é˜µè®¡ç®—çš„éœ€è¦ï¼Œæ‰€ä»¥é€‰æ‹©äº†Intelçš„MKLï¼Œæƒ³åœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹Intelçš„oneAPI Base Toolkitå­¦ä¹ ä½¿ç”¨è¿‡ç¨‹ã€‚</p>

<h2 id="ä¸‹è½½å®‰è£…">ä¸‹è½½å®‰è£…</h2>

<p>https://software.intel.com/content/www/us/en/develop/tools/oneapi/components/onemkl.html#gs.852ahl</p>

<p>è¿›å…¥å®˜ç½‘åæ³¨å†Œè´¦æˆ·å³å¯è¿›è¡Œä¸‹è½½ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©çš„æ˜¯å‘½ä»¤è¡Œä¸‹è½½ã€æœ¬åœ°å®‰è£…</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://registrationcenter-download.intel.com/akdlm/irc_nas/17977/l_BaseKit_p_2021.3.0.3219_offline.sh

<span class="nb">sudo </span>bash l_BaseKit_p_2021.3.0.3219_offline.sh
<span class="c"># è¿™é‡Œæˆ‘é€‰æ‹©å®‰è£…åœ¨æ ¹ç›®å½•ä¸‹æ‰€ä»¥åŠ ä¸Šäº†sudoï¼Œå®‰è£…åœ¨homeç›®å½•ä¸‹åº”è¯¥ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä¸è¿‡è¦è®°ä½è·¯å¾„ä»¥ä¾¿åç»­ç¯å¢ƒå˜é‡é…ç½®</span>
<span class="c"># å®‰è£…è¿‡ç¨‹å…¨éƒ½é»˜è®¤å³å¯ï¼Œä¹Ÿå¯ä»¥è‡ªå·±æ›´æ¢å®‰è£…ç›®å½•</span>
</code></pre></div></div>

<h2 id="å…³äºç›®å½•">å…³äºç›®å½•</h2>

<p><img src="chenwh@Inspiron-7590 _009.png" alt="chenwh@Inspiron-7590 _009" /></p>

<ul>
  <li>oneapi
    <ul>
      <li>mkl/
        <ul>
          <li>2021.3.0/
            <ul>
              <li>include/</li>
              <li>lib/</li>
              <li>å…¶ä»–</li>
            </ul>
          </li>
          <li>latest/ â€“&gt; 2021.3.0/</li>
        </ul>
      </li>
      <li>mpi/</li>
      <li>tbb/</li>
      <li>å…¶ä»–å·¥å…·åŒ…ä»¥åŠå®‰è£…ç¨‹åºç­‰</li>
    </ul>
  </li>
</ul>

<p>ä»¥mklå·¥å…·åŒ…ä¸ºä¾‹ï¼Œåº•ä¸‹å­˜æ”¾æœ‰mklåŒ…çš„å„ä¸ªå†å²ç‰ˆæœ¬ï¼Œåœ¨æˆ‘çš„æˆªå›¾è¿™é‡Œå¯ä»¥çœ‹åˆ°åªæœ‰ 2021.3.0 ä¸€ä¸ªç‰ˆæœ¬å’Œ latest é“¾æ¥ï¼Œlatesté“¾æ¥éšæ›´æ–°ä¼šä¿æŒé“¾æ¥åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œå› æ­¤åœ¨å·¥ç¨‹æ–‡ä»¶é“¾æ¥åº“ç›®å½•çš„æ—¶å€™å¯ä»¥é€‰æ‹© latest è·¯å¾„ï¼Œå½“ç„¶æŒ‡å®šæŸä¸€ç‰ˆæœ¬ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p>

<h2 id="ç¯å¢ƒé…ç½®">ç¯å¢ƒé…ç½®</h2>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># setvars.sh è„šæœ¬é€šè¿‡åœ¨å„è‡ªçš„ oneAPI æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°æ¯ä¸ª &lt;install-dir&gt;/latest/env/vars.sh è„šæœ¬æ¥è®¾ç½®ç”¨äº oneAPI å·¥å…·åŒ…çš„ç¯å¢ƒå˜é‡ã€‚</span>
<span class="nb">source</span> /opt/intel/oneapi/setvars.sh intel64
<span class="c"># ä¸ºäº†é¿å…æ¯æ¬¡æ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯éƒ½éœ€è¦é‡æ–°è¿è¡Œè„šæœ¬ï¼Œå¯ä»¥åœ¨ ${HOME}/.bashrcä¸­æ·»åŠ ä¸€å¥ source /opt/intel/oneapi/setvars.sh intel64</span>
<span class="c"># è¿è¡Œè¿™å¥åoneAPIä¼šæ·»åŠ æ‰€æœ‰å·¥å…·åŒ…ï¼Œå¯èƒ½ä¼šæ±¡æŸ“ä½ çš„å·¥ä½œç¯å¢ƒï¼Œæ¯”å¦‚æˆ‘å°±é‡åˆ°äº† intelpython å½±å“ rospy çš„é—®é¢˜ï¼Œå¯ä»¥å†™ä¸€ä¸ª config.txt æ–‡ä»¶è‡ªå®šä¹‰åŠ è½½çš„ç¯å¢ƒ</span>
<span class="nb">sudo </span>vi /opt/intel/oneapi/config.txt <span class="c"># åœ¨æŒ‡å®šç›®å½•ä¸‹æ–°å»ºäº†ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹</span>
<span class="nv">intelpython</span><span class="o">=</span>exclude <span class="c"># è¿™å¥æ’é™¤äº†intelpythonï¼Œå¯ä»¥è‡ªå·±è¿›è¡Œè®¾ç½®ï¼Œè¿™é‡Œåªæ˜¯ä¸¾äº†æˆ‘çš„ä¾‹å­</span>
<span class="c"># é‚£ä¹ˆsourceè¯­å¥éœ€è¦è¿›è¡Œé€‚å½“ä¿®æ”¹å¦‚ä¸‹</span>
<span class="nb">source</span> /opt/intel/oneapi/setvars.sh <span class="nt">--config</span><span class="o">=</span><span class="s2">"/opt/intel/oneapi/config.txt"</span>

<span class="c">## å…¶ä»–ä¾‹å­å¦‚ä¸‹</span>
mkl <span class="o">=</span> 1.1 <span class="c"># æŒ‡å®šä½¿ç”¨çš„mklç‰ˆæœ¬ï¼Œå¦‚æœä¸æŒ‡å®šé»˜è®¤ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬</span>
default <span class="o">=</span> exclude <span class="c"># æŒ‡å®šé»˜è®¤ä¸ºæ’é™¤æ‰€æœ‰ï¼Œå¦‚æœä¸è®¾ç½®çš„è¯é»˜è®¤æ·»åŠ æ‰€æœ‰å·¥å…·åŒ…</span>

<span class="c">## å»é™¤å‘½ä»¤è¡Œechoè¾“å‡º</span>
<span class="c"># source setvars.shåæ¯æ¬¡å‘½ä»¤è¡Œä¼šå‡ºç°å¾ˆå¤šåé¦ˆï¼Œå¦‚æœåƒæˆ‘ä¸€æ ·å¼ºè¿«ç—‡ä¸å¸Œæœ›æ˜¾ç¤ºçš„è¯å¯ä»¥è¿™æ ·ä¿®æ”¹sourceè¯­å¥</span>
<span class="nb">source</span> /opt/intel/oneapi/setvars.sh <span class="nt">--config</span><span class="o">=</span><span class="s2">"/opt/intel/oneapi/config.txt"</span> <span class="o">&gt;</span> /dev/null
<span class="c"># /dev/null æ˜¯ç±»Unixç³»ç»Ÿä¸­çš„ä¸€ä¸ªç‰¹æ®Šæ–‡ä»¶è®¾å¤‡ï¼Œä»–çš„ä½œç”¨æ˜¯æ¥å—ä¸€åˆ‡è¾“å…¥å®ƒçš„æ•°æ®å¹¶ä¸¢å¼ƒè¿™äº›æ•°æ®ã€‚é€šå¸¸è¢«å½“åšåƒåœ¾æ¡¶æ¥ç”¨ã€‚</span>
</code></pre></div></div>

<h2 id="å¦‚ä½•ä½¿ç”¨">å¦‚ä½•ä½¿ç”¨</h2>

<h3 id="å‘½ä»¤è¡Œç¼–è¯‘">å‘½ä»¤è¡Œç¼–è¯‘</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "mkl.h"
</span><span class="c1">// é¦–å…ˆincludeå¤´æ–‡ä»¶ï¼Œå…·ä½“ç¼–è¯‘é€‰é¡¹éå¸¸å¤æ‚ï¼Œå‚è€ƒä¸‹æ–¹ç½‘ç«™è¿›è¡Œè¡¥å……</span>
</code></pre></div></div>

<p>https://software.intel.com/content/www/us/en/develop/tools/oneapi/components/onemkl/link-line-advisor.html</p>

<h3 id="ä½¿ç”¨cmake">ä½¿ç”¨Cmake</h3>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># CMakeLists.txt</span>
<span class="nb">cmake_minimum_required</span><span class="p">(</span>VERSION 3.0.2<span class="p">)</span>
<span class="nb">project</span><span class="p">(</span>eigen_mkl<span class="p">)</span>
<span class="c1"># set(CMAKE_BUILD_TYPE "Release" )</span>
<span class="c1"># set(CMAKE_BUILD_TYPE "Debug" )</span>
<span class="nb">set</span><span class="p">(</span>CMAKE_CXX_FLAGS <span class="s2">"-O3"</span> <span class="p">)</span>

<span class="c1"># include å¤´æ–‡ä»¶</span>
include_directories
  <span class="si">${</span><span class="nv">catkin_INCLUDE_DIRS</span><span class="si">}</span>
  /opt/intel/oneapi/mkl/latest/include/
<span class="p">)</span>

<span class="c1"># é“¾æ¥åº“ç›®å½•</span>
<span class="nb">link_directories</span><span class="p">(</span>
  <span class="si">${</span><span class="nv">catkin_LIB_DIRS</span><span class="si">}</span>
  /opt/intel/oneapi/mkl/latest/lib/
 <span class="p">)</span>
 
<span class="c1">## æ–‡ä»¶åæ˜¯eigen_mkl.cpp</span>
<span class="nb">add_executable</span><span class="p">(</span>eigen_mkl src/eigen_mkl.cpp<span class="p">)</span>
<span class="c1"># é“¾æ¥å…·ä½“çš„åº“ libmkl_rtï¼Œæ³¨æ„.soæ˜¯åŠ¨æ€åº“ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€‰æ‹©é™æ€åº“ï¼Œä¸è¿‡æ–‡ä»¶ä¼šå¤§äº›ä½†æ›´ç¨³å®šã€‚</span>
<span class="nb">target_link_libraries</span><span class="p">(</span>eigen_mkl
libmkl_rt.so
<span class="p">)</span>
</code></pre></div></div>

<h2 id="ç®€æ˜“æ•™ç¨‹">ç®€æ˜“æ•™ç¨‹</h2>

<h3 id="mkl">MKL</h3>

<p>MKLåªåœ¨çŸ©é˜µè§„æ¨¡å¤§ï¼ˆåƒç»´ä»¥ä¸Šï¼‰æ—¶æ‰æœ‰æ˜æ˜¾æ”¶ç›Šï¼ŒçŸ©é˜µè§„æ¨¡å°çš„è¯ä½¿ç”¨Eigen3åŸºæœ¬æ€§èƒ½å’ŒMKLå·®ä¸å¤šï¼Œç¼–è¯‘æ—¶åŠ ä¸Šâ€-O3â€å°±èƒ½è¾¾åˆ°ç†æƒ³é€Ÿåº¦äº†ã€‚Eigen3é€Šè‰²äºMKLä¹‹å¤„å¤§æ¦‚åœ¨äºå•çº¿ç¨‹ä¸å¤šçº¿ç¨‹ä¹‹å·®ï¼Œå¦‚æœçŸ©é˜µè§„æ¨¡å°çš„è¯å¯èƒ½æ”¶ç›Šéƒ½ä¸è¶³ä»¥å¡«è¡¥æ•°æ®åŒæ­¥çš„å¼€é”€ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// è®¾ç½®MKLè¿è¡Œçš„çº¿ç¨‹æ•°ï¼Œmkl_set_num_threads()</span>
<span class="n">mkl_set_num_threads</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span> <span class="c1">// æˆ‘çš„cpu 6æ ¸12çº¿ç¨‹ï¼Œå®æµ‹ä¸‹æ¥6æ—¶æ€§èƒ½æœ€å¥½</span>
<span class="c1">// æ„å»ºçŸ©é˜µ</span>
<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span><span class="n">mkl_malloc</span><span class="p">(</span> <span class="n">row</span><span class="o">*</span><span class="n">col</span><span class="o">*</span><span class="nf">sizeof</span><span class="p">(</span> <span class="kt">double</span> <span class="p">),</span> <span class="mi">64</span> <span class="p">);</span> <span class="c1">//64ä½</span>
<span class="c1">//é‡Šæ”¾çŸ©é˜µå†…å­˜</span>
<span class="n">mkl_free</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
</code></pre></div></div>

<p>ä¸€äº›BLASçš„åŸºæœ¬çŸ©é˜µè¿ç®—æŒ‡ä»¤å¯ä»¥å‚çœ‹ netlib ç½‘ç«™ http://www.netlib.org/blas/index.html#_cblas</p>

<h3 id="åˆ©ç”¨mklä¸ºeigen3åŠ é€Ÿ">åˆ©ç”¨MKLä¸ºeigen3åŠ é€Ÿ</h3>

<p>å› ä¸ºMKLçš„æŒ‡ä»¤è¾ƒä¸ºå¤æ‚ï¼Œé€šè¿‡eigenè°ƒç”¨ä¼šå‹å¥½å¾ˆå¤šï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è‡ªå·±å†™ä¸€ä¸ªMatrixç±»</p>

<p>https://eigen.tuxfamily.org/dox/TopicUsingIntelMKL.html</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//åœ¨ä½¿ç”¨eigençš„æ–‡ä»¶ä¸­éƒ½æ·»åŠ ä»¥ä¸‹å®</span>
<span class="cp">#define EIGEN_USE_MKL_ALL
</span><span class="c1">//å…·ä½“é“¾æ¥åº“çš„æ“ä½œå¯ä»¥å›çœ‹ä¸Šæ–¹ å¦‚ä½•ä½¿ç”¨ ç« èŠ‚</span>
</code></pre></div></div>

<h3 id="mpi">MPI</h3>

<p>https://mpitutorial.com/</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ç¼–è¯‘</span>
mpicc mpi.c <span class="nt">-o</span> mpi
<span class="c">## è¿è¡Œ</span>
mpirun <span class="nt">-n</span> 4 ./mpi  <span class="c">## å…¶ä¸­4æ˜¯èŠ‚ç‚¹çš„çº¿ç¨‹æ•°</span>
</code></pre></div></div>

:ET